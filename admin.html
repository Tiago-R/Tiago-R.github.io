<!doctype html>
<html lang="pt-PT">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="theme-color" content="#c5a4c1" />
  <title>RSVP Admin - Patrícia & Tiago</title>

  <!-- Bulma (same as main site) -->
  <link rel="stylesheet" href="https://unpkg.com/bulma@0.8.0/css/bulma.min.css" />
  <script src="https://kit.fontawesome.com/2828f7885a.js" crossorigin="anonymous"></script>

  <style>
    :root{
      --accent: #c5a4c1;               /* matches your theme-color */
      --bg: #0f0f14;
      --panel: rgba(255,255,255,0.06);
      --panel-2: rgba(255,255,255,0.09);
      --line: rgba(255,255,255,0.14);
      --text: rgba(255,255,255,0.92);
      --muted: rgba(255,255,255,0.68);
      --shadow: 0 18px 50px rgba(0,0,0,0.28);
      --radius: 18px;
    }

    body{
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
    }

    .wrap{ padding: 28px 14px; }

    .cardish{
      background: linear-gradient(180deg, var(--panel), rgba(255,255,255,0.03));
      border: 1px solid var(--line);
      box-shadow: var(--shadow);
      border-radius: var(--radius);
      padding: 18px;
      backdrop-filter: blur(8px);
    }

    .title, .label{ color: var(--text) !important; }
    .help, .muted{ color: var(--muted) !important; }

    .mono{
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
    }

    /* Inputs */
    .input{
      background: rgba(255,255,255,0.08) !important;
      border-color: rgba(255,255,255,0.18) !important;
      color: var(--text) !important;
      border-radius: 14px;
    }
    .input::placeholder{ color: rgba(255,255,255,0.45) !important; }
    .input:focus{
      border-color: rgba(255,255,255,0.34) !important;
      box-shadow: 0 0 0 0.125em rgba(197,164,193,0.22) !important;
    }

    /* Buttons */
    .button.is-link{
      background-color: rgba(197,164,193,0.26) !important;
      border-color: rgba(197,164,193,0.55) !important;
      color: rgba(255,255,255,0.95) !important;
    }
    .button.is-link:hover{
      background-color: rgba(197,164,193,0.34) !important;
    }
    .button.is-light{
      background-color: rgba(255,255,255,0.10) !important;
      border-color: rgba(255,255,255,0.16) !important;
      color: rgba(255,255,255,0.92) !important;
    }
    .button.is-light:hover{
      background-color: rgba(255,255,255,0.14) !important;
    }

    /* Tags (Yes/No) */
    .tag.is-yes{
      background: rgba(72,199,142,0.22) !important;
      color: #e6fff3 !important;
      border: 1px solid rgba(72,199,142,0.38) !important;
    }
    .tag.is-no{
      background: rgba(241,70,104,0.22) !important;
      color: #ffe6ec !important;
      border: 1px solid rgba(241,70,104,0.38) !important;
    }

    /* Table container */
    .table-container{
      overflow-x: auto;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,0.12);
      background: rgba(255,255,255,0.03);
    }

    /*
      BULMA TABLE OVERRIDES (force dark)
      We scope everything to #rsvpTable to avoid affecting other tables.
      Also we use !important because Bulma sets light backgrounds on cells.
    */
    #rsvpTable,
    #rsvpTable thead,
    #rsvpTable tbody,
    #rsvpTable tr,
    #rsvpTable th,
    #rsvpTable td{
      background-color: transparent !important;
      color: var(--text) !important;
    }

    #rsvpTable thead th{
      background-color: rgba(255,255,255,0.10) !important;
      border-color: rgba(255,255,255,0.16) !important;
      color: rgba(255,255,255,0.90) !important;
      position: sticky;
      top: 0;
      z-index: 1;
    }

    #rsvpTable td,
    #rsvpTable th{
      border-color: rgba(255,255,255,0.12) !important;
      vertical-align: top;
    }

    /* Zebra stripes applied to TDs (Bulma often colors td backgrounds) */
    #rsvpTable tbody tr:nth-child(odd) td{
      background-color: rgba(255,255,255,0.04) !important;
    }
    #rsvpTable tbody tr:nth-child(even) td{
      background-color: rgba(255,255,255,0.06) !important;
    }

    /* Hover: tint with your accent */
    #rsvpTable.table.is-hoverable tbody tr:hover td{
      background-color: rgba(197,164,193,0.18) !important;
    }

    /* Links (just in case) */
    #rsvpTable a{ color: var(--text) !important; text-decoration: underline; }

    /* Small chips */
    .pill{
      display: inline-block;
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,0.16);
      background: rgba(255,255,255,0.06);
      color: var(--muted);
      font-size: 0.9rem;
    }
  </style>
</head>

<body>
  <section class="wrap">
    <div class="container">
      <div class="columns is-centered">
        <div class="column is-12 is-10-desktop">

          <div class="cardish">
            <div class="level">
              <div class="level-left">
                <div>
                  <h1 class="title is-4">RSVP Admin</h1>
                  <p class="help">Lista de confirmações para o casamento da Patrícia &amp; Tiago.</p>
                </div>
              </div>
              <div class="level-right">
                <span id="summary" class="pill">0 RSVPs</span>
              </div>
            </div>

            <div class="columns is-variable is-3" style="margin-top: 12px;">
              <div class="column is-7">
                <div class="field">
                  <label class="label">Admin token</label>
                  <div class="control has-icons-left">
                    <input id="token" class="input" type="password" placeholder="Cole aqui o token (não é guardado)">
                    <span class="icon is-small is-left"><i class="fas fa-key"></i></span>
                  </div>
                  <p class="help">Este token corresponde ao <span class="mono">ADMIN_TOKEN</span> no Worker.</p>
                </div>
              </div>

              <div class="column is-5">
                <div class="field">
                  <label class="label">Ações</label>
                  <div class="buttons">
                    <button id="load" class="button is-link is-rounded">
                      <span class="icon"><i class="fas fa-sync"></i></span>
                      <span>Carregar</span>
                    </button>
                    <button id="export" class="button is-light is-rounded" disabled>
                      <span class="icon"><i class="fas fa-file-csv"></i></span>
                      <span>Exportar CSV</span>
                    </button>
                  </div>
                  <p id="status" class="muted"></p>
                </div>
              </div>
            </div>

            <div class="table-container" style="margin-top: 14px;">
              <table id="rsvpTable" class="table is-fullwidth is-hoverable">
                <thead>
                  <tr>
                    <th>ID</th>
                    <th>Quando</th>
                    <th>Nome</th>
                    <th>Email</th>
                    <th>Presença</th>
                    <th>Pessoas</th>
                    <th>Notas</th>
                  </tr>
                </thead>
                <tbody id="rows"></tbody>
              </table>
            </div>

            <p class="help mono" style="margin-top: 10px;">
              Dica: se precisar de trocar o token, corra <span class="mono">wrangler secret put ADMIN_TOKEN</span> e depois <span class="mono">wrangler deploy</span>.
            </p>
          </div>

        </div>
      </div>
    </div>
  </section>

  <script>
    // Replace with your deployed Worker URL
    // Example: https://rsvp-worker.yourname.workers.dev/admin/rsvps?limit=400
    const API_ADMIN_URL = "https://wedding.tiagoalfredo-rocha.workers.dev/admin/rsvps?limit=400";

    const tokenEl = document.getElementById("token");
    const loadBtn = document.getElementById("load");
    const exportBtn = document.getElementById("export");
    const statusEl = document.getElementById("status");
    const rowsEl = document.getElementById("rows");
    const summaryEl = document.getElementById("summary");

    let lastResults = [];

    function esc(s) {
      return String(s ?? "").replace(/[&<>"']/g, c => ({
        "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"
      }[c]));
    }

    function toCsv(rows) {
      const header = ["id","created_at","name","email","attending","guests","notes"];
      const lines = [header.join(",")];

      for (const r of rows) {
        const vals = [
          r.id,
          r.created_at,
          r.name,
          r.email ?? "",
          r.attending ? "yes" : "no",
          r.guests,
          (r.notes ?? "").replace(/\r?\n/g, " ")
        ].map(v => {
          const str = String(v ?? "");
          return `"${str.replace(/"/g, '""')}"`;
        });

        lines.push(vals.join(","));
      }
      return lines.join("\n");
    }

    function download(filename, text) {
      const blob = new Blob([text], { type: "text/csv;charset=utf-8" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
    }

    async function loadRsvps() {
      rowsEl.innerHTML = "";
      statusEl.textContent = "A carregar…";
      exportBtn.disabled = true;

      const token = tokenEl.value.trim();
      if (!token) {
        statusEl.textContent = "Falta o token.";
        return;
      }

      loadBtn.classList.add("is-loading");

      let res;
      try {
        res = await fetch(API_ADMIN_URL, {
          headers: { "Authorization": `Bearer ${token}` }
        });
      } catch (e) {
        statusEl.textContent = "Falha ao ligar ao servidor (verifique URL/CORS).";
        loadBtn.classList.remove("is-loading");
        return;
      }

      const out = await res.json().catch(() => ({}));

      if (!res.ok) {
        statusEl.textContent = out.error || "Não foi possível carregar os RSVPs.";
        loadBtn.classList.remove("is-loading");
        return;
      }

      lastResults = out.results || [];
      const total = lastResults.length;
      const yesCount = lastResults.filter(r => !!r.attending).length;
      const noCount  = total - yesCount;
      const guestSum = lastResults.reduce((acc, r) => acc + Number(r.guests || 0), 0);

      summaryEl.textContent = `${total} RSVPs · ${yesCount} Sim · ${noCount} Não · ${guestSum} pessoas`;
      statusEl.textContent = total ? "Carregado." : "Sem RSVPs ainda.";
      exportBtn.disabled = total === 0;

      rowsEl.innerHTML = lastResults.map(r => `
        <tr>
          <td>${esc(r.id)}</td>
          <td class="mono">${esc(r.created_at)}</td>
          <td>${esc(r.name)}</td>
          <td>${esc(r.email)}</td>
          <td>${r.attending ? '<span class="tag is-yes">Sim</span>' : '<span class="tag is-no">Não</span>'}</td>
          <td>${esc(r.guests)}</td>
          <td>${esc(r.notes)}</td>
        </tr>
      `).join("");

      loadBtn.classList.remove("is-loading");
    }

    loadBtn.addEventListener("click", loadRsvps);

    exportBtn.addEventListener("click", () => {
      const csv = toCsv(lastResults);
      const ts = new Date().toISOString().slice(0,19).replace(/[:T]/g,"-");
      download(`rsvps-${ts}.csv`, csv);
    });
  </script>
</body>
</html>